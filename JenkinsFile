pipeline {
    agent any

    environment {
        AWS_ACCESS_KEY_ID     = credentials('aws-creds')
        AWS_SECRET_ACCESS_KEY = credentials('aws-creds')
        AWS_DEFAULT_REGION    = 'ap-south-1'
    }

    stages {

        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('Terraform Init') {
            steps {
                sh 'terraform init'
            }
        }

        stage('Terraform Apply') {
            steps {
                sh '''
                  terraform apply -auto-approve \
                    -var="key_name=key"
                '''
            }
        }

        stage('Get EC2 Public IPs') {
            steps {
                script {
                    def ips = sh(
                        script: "terraform output -json ec2_public_ips | jq -r '.[]'",
                        returnStdout: true
                    ).trim().split('\n')

                    env.EC2_IPS = ips.join(',')
                    echo "EC2 Public IPs: ${env.EC2_IPS}"
                }
            }
        }

        stage('Install Docker on EC2s') {
            steps {
                sshagent(['ubuntu']) {
                    script {
                        env.EC2_IPS.split(',').each { ip ->
                            sh """
                            echo "Installing Docker on ${ip}"
                            ssh -o StrictHostKeyChecking=no ubuntu@${ip} '
                                sudo apt update -y
                                sudo apt install -y docker.io
                                sudo systemctl start docker
                                sudo systemctl enable docker
                                sudo usermod -aG docker ubuntu
                            '
                            """
                        }
                    }
                }
            }
        }

        stage('Deploy Application') {
            steps {
                sshagent(['ubuntu']) {
                    script {
                        env.EC2_IPS.split(',').each { ip ->
                            sh """
                            echo "Deploying application on ${ip}"
                            ssh -o StrictHostKeyChecking=no ubuntu@${ip} '
                                docker pull bansil374/pyapp
                                docker stop pythoncontainer || true
                                docker rm pythoncontainer || true
                                docker run -d \
                                  -p 8082:8081 \
                                  --name pythoncontainer \
                                  bansil374/pyapp
                            '
                            """
                        }
                    }
                }
            }
        }
    }

    post {
        success {
            echo " Deployment completed successfully on all EC2 instances"
        }
        failure {
            echo " Deployment failed. Check logs above."
        }
    }
}
