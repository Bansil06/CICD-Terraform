pipeline {
    agent any

    environment {
        AWS_ACCESS_KEY_ID     = credentials('aws-creds')
        AWS_SECRET_ACCESS_KEY = credentials('aws-creds')
        AWS_DEFAULT_REGION    = 'ap-south-1'
    }

    stages {

        stage('Terraform Init') {
            steps {
                sh 'terraform init'
            }
        }

stage('Terraform Apply') {
    steps {
        sh '''
          terraform apply -auto-approve \
            -var="key_name=key"
        '''
    }
}

        stage('Get EC2 IP from Terraform') {
            steps {
                script {
                    EC2_IP = sh(
                        script: 'terraform output -raw ec2_public_ip',
                        returnStdout: true
                    ).trim()

                    echo "EC2 Public IP: ${EC2_IP}"
                }
            }
        }

        stage('Install Docker on EC2') {
            steps {
                sh """
                ssh -o StrictHostKeyChecking=no -i /var/lib/jenkins/.ssh/key.pem ubuntu@${EC2_IP} << EOF
                  sudo apt update -y
                  sudo apt install -y docker.io
                  sudo systemctl start docker
                  sudo systemctl enable docker
                  sudo usermod -aG docker ubuntu
                EOF
                """
            }
        }

        stage('Deploy Application') {
            steps {
                sh """
                ssh -o StrictHostKeyChecking=no -i /var/lib/jenkins/.ssh/key.pem ubuntu@${EC2_IP} << EOF
                  docker pull bansil374/pyapp
                  docker stop app || true
                  docker rm app || true
                  docker run -d -p 8080:8080 --name app bansil374/pyapp
                EOF
                """
            }
        }
    }
}
